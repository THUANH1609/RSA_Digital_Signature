<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K√Ω & Truy·ªÅn File RSA</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        body {
            background-color: #f8f9fa; /* N·ªÅn m√†u x√°m nh·∫°t */
            font-family: 'Inter', sans-serif; /* S·ª≠ d·ª•ng font Inter */
        }
        .container {
            max-width: 900px; /* Container r·ªông h∆°n m·ªôt ch√∫t */
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.1);
            margin-bottom: 1.5rem; /* Th√™m kho·∫£ng tr·ªëng gi·ªØa c√°c card */
        }
        .card-header {
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            font-weight: bold;
        }
        .alert-info-custom {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.25rem;
        }
        .alert-info-custom ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
        }
        .alert-info-custom li {
            margin-bottom: 5px;
        }
        .alert-info-custom li a {
            font-weight: bold;
            color: #007bff;
            text-decoration: none; /* B·ªè g·∫°ch ch√¢n */
        }
        .alert-info-custom .lead {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .icon {
            margin-right: 5px;
        }
        .nav-link.active {
            font-weight: bold;
            color: #0d6efd !important; /* M√†u ch√≠nh c·ªßa Bootstrap */
            border-bottom: 2px solid #0d6efd;
        }
        .file-drop-area {
            border: 2px dashed #007bff;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .file-drop-area:hover {
            background-color: #e9f5ff;
        }
        .file-drop-area input[type="file"] {
            display: none;
        }
        .status-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4 text-center">üîê ·ª®ng d·ª•ng k√Ω, x√°c minh v√† truy·ªÅn file v·ªõi RSA</h2>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="sign-verify-tab" data-bs-toggle="tab" data-bs-target="#sign-verify" type="button" role="tab" aria-controls="sign-verify" aria-selected="true">K√Ω & X√°c minh</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="send-file-tab" data-bs-toggle="tab" data-bs-target="#send-file" type="button" role="tab" aria-controls="send-file" aria-selected="false">G·ª≠i File</button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="sign-verify" role="tabpanel" aria-labelledby="sign-verify-tab">
            <div class="card">
                <div class="card-header bg-primary text-white">T·∫°o kh√≥a & K√Ω file</div>
                <div class="card-body">
                    <form method="post" action="/sign" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="file" class="form-label">Ch·ªçn file ƒë·ªÉ k√Ω:</label>
                            <input type="file" class="form-control" name="file" required>
                        </div>
                        <button type="submit" class="btn btn-primary">K√Ω file</button>
                    </form>

                    {% if key_created %}
                        <div class="mt-4 alert alert-success rounded-3">
                            ‚úÖ ƒê√£ t·∫°o kh√≥a v√† k√Ω file th√†nh c√¥ng!
                            <p>üîë M√£ bƒÉm SHA-256 c·ªßa file: <code>{{ hash_code }}</code></p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-success text-white">X√°c minh ch·ªØ k√Ω</div>
                <div class="card-body">
                    <p>X√°c minh ch·ªØ k√Ω</p>
                    
                    {% if original_filename and signature_filename and public_key_filename %}
                        <div class="alert-info-custom rounded-3">
                            <p class="lead"><span class="icon">‚¨áÔ∏è</span> T·∫£i v·ªÅ file v·ª´a k√Ω:</p>
                            <ul>
                                <li><a href="{{ url_for('download_file', filename=original_filename) }}"><span class="icon">üìÑ</span> File g·ªëc: {{ original_filename }}</a></li>
                                <li><a href="{{ url_for('download_file', filename=signature_filename) }}"><span class="icon">üìù</span> Ch·ªØ k√Ω (.sig): {{ signature_filename }}</a></li>
                                <li><a href="{{ url_for('download_file', filename=public_key_filename) }}"><span class="icon">üîë</span> Public Key (.pem): {{ public_key_filename }}</a></li>
                            </ul>
                        </div>
                    {% endif %}

                    <form method="post" action="/verify" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="verify_file_input" class="form-label">File g·ªëc:</label>
                            <input type="file" class="form-control" name="verify_file" id="verify_file_input" required>
                        </div>
                        <div class="mb-3">
                            <label for="verify_sig_input" class="form-label">Ch·ªØ k√Ω:</label>
                            <input type="file" class="form-control" name="verify_sig" id="verify_sig_input" required>
                        </div>
                        <div class="mb-3">
                            <label for="verify_pub_input" class="form-label">Public Key (T√πy ch·ªçn):</label>
                            <input type="file" class="form-control" name="verify_pub" id="verify_pub_input">
                        </div>
                        <button type="submit" class="btn btn-success"><span class="icon">‚úÖ</span> X√°c minh ch·ªØ k√Ω</button>
                    </form>

                    {% if verify_result %}
                        <div class="mt-3 alert alert-{{ 'success' if verify_result == 'H·ª£p l·ªá' else 'danger' }} rounded-3">
                            <span class="icon">‚úÖ</span> K·∫øt qu·∫£ x√°c minh: <strong>{{ verify_result }}</strong>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="send-file" role="tabpanel" aria-labelledby="send-file-tab">
            <div class="card">
                <div class="card-header bg-info text-white">G·ª≠i File</div>
                <div class="card-body">
                    <form id="send-file-form" method="post" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="recipient_ip" class="form-label">Nh·∫≠p ƒë·ªãa ch·ªâ IP ng∆∞·ªùi nh·∫≠n:</label>
                            <input type="text" class="form-control" id="recipient_ip" name="recipient_ip" placeholder="" required>
                        </div>
                        <div class="mb-3">
                            <label for="file_to_send" class="form-label">Ch·ªçn file ƒë·ªÉ g·ª≠i:</label>
                            <input type="file" class="form-control" name="file_to_send" id="file_to_send" required>
                        </div>
                        <button type="submit" class="btn btn-info text-white"><span class="icon">‚¨ÜÔ∏è</span> G·ª≠i File</button>
                    </form>
                    <div id="send-status" class="status-message d-none"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // X·ª≠ l√Ω vi·ªác g·ª≠i form G·ª≠i File
        const sendFileForm = document.getElementById('send-file-form');
        const sendStatusDiv = document.getElementById('send-status');

        sendFileForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // NgƒÉn ch·∫∑n g·ª≠i form m·∫∑c ƒë·ªãnh

            sendStatusDiv.classList.remove('d-none', 'status-success', 'status-error', 'status-info');
            sendStatusDiv.classList.add('status-info');
            sendStatusDiv.innerHTML = 'ƒêang k·∫øt n·ªëi v√† g·ª≠i file...';

            const formData = new FormData(sendFileForm);
            const recipientIp = formData.get('recipient_ip');
            const fileToSend = formData.get('file_to_send');

            // L·∫•y th√¥ng tin file ƒë√£ k√Ω g·∫ßn nh·∫•t t·ª´ session (n·∫øu c√≥)
            const originalFilename = "{{ session.get('original_filename', '') }}";
            const signatureFilename = "{{ session.get('signature_filename', '') }}";
            const publicKeyFilename = "{{ session.get('public_key_filename', '') }}";

            if (!originalFilename || !signatureFilename || !publicKeyFilename) {
                sendStatusDiv.classList.remove('status-info');
                sendStatusDiv.classList.add('status-error');
                sendStatusDiv.innerHTML = 'L·ªói: Vui l√≤ng k√Ω m·ªôt file tr∆∞·ªõc khi g·ª≠i ƒë·ªÉ c√≥ ch·ªØ k√Ω v√† Public Key.';
                return;
            }

            // T·∫°o ƒë·ªëi t∆∞·ª£ng FormData m·ªõi cho y√™u c·∫ßu g·ª≠i th·ª±c t·∫ø
            const sendData = new FormData();
            sendData.append('recipient_ip', recipientIp);
            sendData.append('file_to_send', fileToSend);
            sendData.append('original_filename_signed', originalFilename);
            sendData.append('signature_filename_signed', signatureFilename);
            sendData.append('public_key_filename_signed', publicKeyFilename);

            try {
                // G·ª≠i y√™u c·∫ßu ƒë·∫øn endpoint /send_to_ip c·ªßa backend Flask
                const response = await fetch('/send_to_ip', {
                    method: 'POST',
                    body: sendData
                });

                const result = await response.json();

                sendStatusDiv.classList.remove('status-info');
                if (response.ok) {
                    sendStatusDiv.classList.add('status-success');
                    sendStatusDiv.innerHTML = `G·ª≠i file th√†nh c√¥ng! Ph·∫£n h·ªìi t·ª´ ng∆∞·ªùi nh·∫≠n: ${result.message}`;
                } else {
                    sendStatusDiv.classList.add('status-error');
                    sendStatusDiv.innerHTML = `L·ªói g·ª≠i file: ${result.message || 'Kh√¥ng r√µ l·ªói'}`;
                }
            } catch (error) {
                sendStatusDiv.classList.remove('status-info');
                sendStatusDiv.classList.add('status-error');
                sendStatusDiv.innerHTML = `L·ªói k·∫øt n·ªëi ho·∫∑c m·∫°ng: ${error.message}`;
                console.error('L·ªói khi g·ª≠i file:', error);
            }
        });

        // Kh·ªüi t·∫°o tab Bootstrap
        var triggerTabList = [].slice.call(document.querySelectorAll('#myTab button'))
        triggerTabList.forEach(function (triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl)

            triggerEl.addEventListener('click', function (event) {
                event.preventDefault()
                tabTrigger.show()
            })
        })
    });
</script>
</body>
</html>